version: "3.9"
services:
  api:
    build: {context: ., dockerfile: infrastructure/docker/Dockerfile.api}
    ports: ["8000:8000"]
    environment:
      - ENVIRONMENT=production
      - POSTGRES_HOST=postgres
      - REDIS_HOST=redis
    volumes: [upload_data:/data/uploads, model_data:/data/models]
    depends_on: {postgres: {condition: service_healthy}, redis: {condition: service_healthy}}
    restart: unless-stopped
    networks: [deepfake-net]

  worker:
    build: {context: ., dockerfile: infrastructure/docker/Dockerfile.worker}
    command: celery -A app.workers.celery_app worker -l info -c 4
    depends_on: [api, redis]
    restart: unless-stopped
    networks: [deepfake-net]

  beat:
    build: {context: ., dockerfile: infrastructure/docker/Dockerfile.worker}
    command: celery -A app.workers.celery_app beat -l info
    depends_on: [worker]
    restart: unless-stopped
    networks: [deepfake-net]

  frontend:
    build: {context: ., dockerfile: infrastructure/docker/Dockerfile.frontend}
    ports: ["3000:3000"]
    depends_on: [api]
    restart: unless-stopped
    networks: [deepfake-net]

  postgres:
    image: postgres:16-alpine
    environment: {POSTGRES_USER: deepfake_user, POSTGRES_PASSWORD: changeme, POSTGRES_DB: deepfake_detector}
    volumes: [postgres_data:/var/lib/postgresql/data]
    ports: ["5432:5432"]
    healthcheck: {test: ["CMD-SHELL", "pg_isready -U deepfake_user"], interval: 10s, timeout: 5s, retries: 5}
    restart: unless-stopped
    networks: [deepfake-net]

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    volumes: [redis_data:/data]
    healthcheck: {test: ["CMD", "redis-cli", "ping"], interval: 10s}
    restart: unless-stopped
    networks: [deepfake-net]

  nginx:
    image: nginx:alpine
    ports: ["80:80", "443:443"]
    volumes: [./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf]
    depends_on: [api, frontend]
    restart: unless-stopped
    networks: [deepfake-net]

  prometheus:
    image: prom/prometheus:latest
    ports: ["9090:9090"]
    volumes: [./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml]
    restart: unless-stopped
    networks: [deepfake-net]

  grafana:
    image: grafana/grafana:latest
    ports: ["3001:3000"]
    restart: unless-stopped
    networks: [deepfake-net]

volumes:
  postgres_data:
  redis_data:
  upload_data:
  model_data:

networks:
  deepfake-net:
    driver: bridge
