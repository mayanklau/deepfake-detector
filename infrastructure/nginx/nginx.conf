worker_processes auto;
events { worker_connections 4096; }
http {
    include /etc/nginx/mime.types;
    sendfile on;
    client_max_body_size 500M;
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;

    limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/m;

    upstream api { server api:8000; }
    upstream frontend { server frontend:3000; }

    server {
        listen 80;
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;

        location /api/ { limit_req zone=api burst=20; proxy_pass http://api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_read_timeout 300; }
        location /api/v1/auth { limit_req zone=auth burst=3; proxy_pass http://api; }
        location /api/v1/realtime/ws/ { proxy_pass http://api; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade"; }
        location /health { proxy_pass http://api; }
        location / { proxy_pass http://frontend; proxy_set_header Host $host; }
    }
}
